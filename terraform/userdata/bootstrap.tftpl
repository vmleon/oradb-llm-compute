#!/bin/bash

touch /home/opc/bootstrap.lock

# Update and upgrade repo
echo "dnf update" >> /home/opc/bootstrap.lock
dnf update -y
echo "dnf upgrade" >> /home/opc/bootstrap.lock
dnf upgrade -y

# Install Ollama
echo "install ollama" >> /home/opc/bootstrap.lock
curl -fsSL https://ollama.com/install.sh | sh

# Configure Ollama to listen on all interfaces with explicit port
echo "add environment OLLAMA_HOST" >> /home/opc/bootstrap.lock
mkdir -p /etc/systemd/system/ollama.service.d
cat > /etc/systemd/system/ollama.service.d/override.conf << EOF
[Service]
Environment="OLLAMA_HOST=0.0.0.0:11434"
EOF

# Reload systemd and start Ollama service
echo "daemon-reload" >> /home/opc/bootstrap.lock
systemctl daemon-reload
systemctl enable ollama
echo "ollama start" >> /home/opc/bootstrap.lock
systemctl start ollama

# Pull a default model
echo "ollama pull" >> /home/opc/bootstrap.lock
sleep 10
ollama pull llama3.2:3b

# Pre-load the model into memory for faster responses
echo "ollama model pre-load" >> /home/opc/bootstrap.lock
ollama run llama3.2 ""

# Disable firewalld
echo "firewalld stop" >> /home/opc/bootstrap.lock
systemctl stop firewalld
echo "firewalld disable" >> /home/opc/bootstrap.lock
systemctl disable firewalld

rm /home/opc/bootstrap.lock